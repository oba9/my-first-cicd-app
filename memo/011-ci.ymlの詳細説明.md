# まずは読み解き（行ごとの意味）

```yaml
name: CI Pipeline
```

* ワークフローのタイトル。Actions画面での表示名になります。

```yaml
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
```

* **いつ動くか（トリガー）**の設定。

  * `push`: `main` ブランチにプッシュされたら実行。
  * `pull_request`: `main` 宛のPRを作成/更新したら実行。

```yaml
jobs:
  build-and-test:
    runs-on: ubuntu-latest
```

* 実行する**ジョブ**の名前は `build-and-test`。
* **どのOSで動かすか** → GitHubが用意した最新の Ubuntu 仮想マシン。

```yaml
    steps:
    - name: コードを取得
      uses: actions/checkout@v3
```

* **ステップ（手順）**の開始。
* `checkout` は「リポジトリの中身をこの仮想マシンに持ってくる」アクション。
  ※最新版は `@v4` が推奨。

```yaml
    - name: Node.jsをセットアップ
      uses: actions/setup-node@v3
      with:
        node-version: '18'
```

* Node.js をインストール。`18` を使う指定。
  ※こちらも最新版は `@v4` が推奨。
  ※npmのキャッシュ設定も併用すると速くなります。

```yaml
    - name: 依存関係をインストール
      run: npm install
```

* `package.json` に書かれた外部ライブラリを入れる。
  ※CIでは**再現性と速度**のため `npm ci` を使うのが定番です（後述）。

```yaml
    - name: アプリを実行
      run: node app.js
```

* アプリを起動。
  ⚠️ **要注意**：CI上でサーバーを起動しっぱなしにすると**処理が終わらずタイムアウト**しがちです。
  通常のCIでは「起動してテストして終了」まで自動化します。
  例）`npm test` / `npm run build` / `start-server-and-test` などを使う。

---

# よくある改善ポイント（超重要）

1. **アクションは最新版に**

* `actions/checkout@v4`、`actions/setup-node@v4` に更新。

2. **依存は `npm ci`**

* ロックファイル（`package-lock.json`）をもとに**速く・同じ状態**でインストールできます。
  → CIの定番。

3. **npmキャッシュで高速化**

* `setup-node` に `cache: 'npm'` を付けると依存の再インストールが速くなります。

4. **“実行しっぱなし”を避ける**

* `node app.js` は終了しないためCIが終わらないことが多いです。
* 実用は「**テストを回す**」「**ビルドだけ**」「**一時的に起動→疎通確認→止める**」にします。

  * Webアプリなら `start-server-and-test` （一時起動→テスト→終了）が簡単。
  * APIの疎通なら `curl` で`200`確認して終了。

5. **PR用に失敗を早く知る**

* Lint（`npm run lint`）やユニットテスト（`npm test`）を入れておく。

---

# 改善版①：テスト重視（最小で実用）

```yaml
name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # ① ソース取得
      - name: Checkout
        uses: actions/checkout@v4

      # ② Nodeセットアップ + npmキャッシュ
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # ③ 依存インストール（再現性◎）
      - name: Install deps
        run: npm ci

      # ④ Lint（あれば）
      - name: Lint
        run: npm run lint --if-present

      # ⑤ テスト実行
      - name: Test
        run: npm test

      # ⑥ ビルド（フロントなら任意）
        # package.json に "build" がない場合でも落ちないように --if-present
      - name: Build
        run: npm run build --if-present
```

> これが一番“CIらしい”形です。**テストが落ちたらPRを止める**という役割がはっきりします。

---

# 改善版②：一時起動→疎通テスト→終了（サーバー系）

> `package.json` に次のスクリプトを用意しておくとスムーズです

```json
{
  "scripts": {
    "start": "node app.js",
    "start:ci": "node app.js & sleep 2",        // 2秒だけ待って（起動待ち）
    "healthcheck": "curl -fsS http://localhost:3000/health || exit 1",
    "test": "echo \"(任意のテストを実装してください)\" && exit 0"
  }
}
```

**ワークフロー**

```yaml
name: CI (server check)

on: [push, pull_request]

jobs:
  run-and-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      # サーバーを一時起動（バックグラウンド）
      - name: Start server (temp)
        run: npm run start:ci

      # ヘルスチェック
      - name: Health check
        run: npm run healthcheck

      # ここで必要なら統合テストなど
      - name: Test
        run: npm test
```

> ずっと起動しっぱなしにせず、**起動→確認→終わる**流れにするのがコツ。

---

# 便利オプション（必要に応じて）

* **ブランチやパスでの実行制御**

  ```yaml
  on:
    push:
      branches: [ "main" ]
      paths-ignore:
        - "docs/**"
        - "**/*.md"
  ```
* **Nodeの複数バージョンで同時テスト（行列）**

  ```yaml
  strategy:
    matrix:
      node-version: [18, 20, 22]
  ```
* **アーティファクト保存**

  ```yaml
  - uses: actions/upload-artifact@v4
    with:
      name: dist
      path: dist
  ```
* **Secrets（APIキー等）を環境変数で渡す**

  ```yaml
  - run: node app.js
    env:
      API_KEY: ${{ secrets.API_KEY }}
  ```
* **concurrency（同時実行の重複を防ぐ）**

  ```yaml
  concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true
  ```

---

# まとめ（最重要ポイント）

* `checkout@v4` / `setup-node@v4` を使う
* 依存は `npm ci`、`cache: 'npm'` で高速化
* **CIでサーバーを起動しっぱなしにしない**（テスト/疎通確認して終了）
* Lint/テストを入れて、PRで壊れたら即わかるようにする

